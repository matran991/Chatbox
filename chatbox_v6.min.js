function close_video(){$(".popup").fadeOut(500),$(this).next().remove()}function youtube(){var e=$(this).attr("href"),a='<iframe width="480" height="320" src="'+e+'?autoplay=1" frameborder="0" allowfullscreen=""></iframe>';$(".video").append(a),$(".popup").fadeIn(500)}function onchat(){$.get("/chatbox/actions.forum?archives=1&avatar=0&method=connect&tid="+tid).done(function(e){getchat(),chat_data=e})}function copyname(){$("#text").val(""+$("#text").val()+"  "+$(this).text()+": ")}function chat_tab(){var e=$(this).attr("data"),a=$(this).attr("style"),t=Number(new Date),n=$(this).text();if(user_chatlv>1&&nickname!=n&&($(".tab_level").fadeIn(500),$(".tab_level span").attr("name",""+n)),"true"==e&&0==$('.list_pri a[data="'+n+'"]').length&&n!=nickname)$("#Cboxvhg").attr("key",""+t),$(".result").fadeOut(500),$("#Chatboxvhg").append('<div class="result" key="'+t+'"></div>'),$(".list_pri").append('<div class="block_pri"><a style="'+a+'" href="javascript:;" onclick="show_pri.call(this);" key="'+t+'" data="'+n+'">'+n+"</a></div>");else if(n==nickname)alert("Bạn không thể tự gửi cho chính mính.");else if($('.list_pri a[data="'+n+'"]').length>0){$(".result").hide();var e=$('.list_pri a[data="'+n+'"]').attr("key");$('.result[key="'+e+'"]').fadeIn(500)}else lert("Thành viên này đã rời khỏi chatbox.")}function control(){var e=$(this).attr("name"),a=$(this).attr("data"),t=encodeURIComponent("/"+a+" "+e);if($(".tab_level").fadeOut(500),"close"==a)$(".tab_level").fadeOut(500);else if(data_chat="message="+t+"&method=send&archives=1",sendchat(),"band"==a){localStorage.setItem("user_band",""+e);var n='<a style="color:#000000" data="false" href="javascript:;" onmousedown="bandder.call(this);event.preventDefault();">'+e+"</a>";$(".list_onl .user_band").append(n)}}function bandder(){var e=confirm("Unband thành viên này chứ?");if(1==e){localStorage.clear("user_band");var a=$(this).text(),t=encodeURIComponent("/unband "+a);$(".user_band").html(""),data_chat="message="+t+"&method=send&archives=1",sendchat()}}function show_pri(){var e=$(this).attr("key");$(".rprimsg,.result").hide(),$('.result[key="'+e+'"],.rchatall').fadeIn(500),$("#Cboxvhg").attr("key",""+e)}function rpri(){var e=$(this).attr("key");$(".rprimsg").hide(),$('.result[key="'+e+'"],.rchatall').fadeIn(500),$("#Cboxvhg").attr("key",""+e)}function chatall(){$(".result").hide(),$('.result[key="chatall"],.rprimsg').fadeIn(500),$("#Cboxvhg").attr("key","chatall")}function user_onl(){if(getdata.users){for(var e="",a=0;a<getdata.users.length;a++){var t=getdata.users[a],n='<a style="color:'+t.color+'" data="'+t.online+'" href="javascript:;" onmousedown="chat_tab.call(this);">'+t.username+"</a>";e+=n,t.username==nickname&&(user_admin=t.admin,user_chatlv=t.chatLevel,user_userlv=t.userLevel)}$(".list_onl .user_onl").html(e)}}function buzzon(){"true"==buzz&&($("body").toggleClass("shake animated infinite"),$("#chatbox-buzz-audio")[0].play(),buzz="false",setTimeout(function(){$("body").removeClass("shake animated infinite")},2e3))}function primsg(){var e=getdata.messages.length-1;$(".result").not('.result[key="chatall"]').html("");for(var a=e;a>-1;a--){var t=getdata.messages[a];if(void 0==t.user||null==t.user_avatar.length)var n="";else if(null!=t.user_avatar.length)var n='<img src="'+t.user.avatar+'" />';else{t.user.color}if(t.msg.indexOf("||"+nickname+"||")>-1&&"none"!=nickname){var s=t.msg.split("||"),r=s[0],l=s[1],i=s[2],c=s[3];if(l==nickname)var o=i;else if(i==nickname)var o=l;if(0==$('#Chatboxvhg .result[key="'+r+'"]').length&&($(".tit_pri,.list_pri").fadeIn(500),0==$('.box_onl .list_pri a[data="'+o+'"]').length&&$(".box_onl .list_pri").append('<div class="block_pri"><a href="javascript:;" onclick="show_pri.call(this);" key="'+r+'" data="'+o+'">'+o+'</a><span class="number" name="'+o+'"></span></div>'),$("#Chatboxvhg").append('<div class="result" key="'+r+'" style="display:none"></div>')),c.search(/www\.youtube\.com\/embed|/gi)>-1)var c=c.replace(/href\=\"http\:/gi,'onclick="event.preventDefault();youtube.call(this);" href="http://');var h='<p key="'+r+'" class="block_mess">';h+='<span class="chat_msg"><span class="chat_name">'+n+'<a style="color:'+t.user.color+'" href="/u'+t.userId+'" onclick="event.preventDefault();copyname.call(this)">'+t.username+'</a>: </span><span class="chat_content">'+Base64.decode(c)+"</span></span>",h+="</p>",$('#Chatboxvhg .result[key="'+r+'"]').append(h),$(".result").not('.result[key="chatall"]').each(function(){var e=$(this).find(".block_mess").attr("key"),a=$(this).find(".block_mess").length;$('.block_pri a[key="'+e+'"]').next().text(a)})}}}function msgchat(){if(getdata.messages&&(contentz="",getdata.messages))if(0==lastmess||0==$('.result[key="chatall"] p').length){lastmess=getdata.messages.length;for(var e=getdata.messages.length-1,a=e;a>-1;a--){var t=getdata.messages[a],n=t.userId,s=t.username,r=t.msg;if(r.search(/kicked by|banned by|Messages cleared/gi)>-1)var r=""+r.replace("has been unbanned by","đã được unbanded bởi").replace("has been kicked by","đã bị đá ra khỏi phòng bởi").replace("Messages cleared by","Các tin nhắn đã bị xóa bởi").replace("has been banned by","đã bị banded bởi"),l='<p class="block_mess"><span class="chat_content warning">'+r+"</span></p>";else if(r.indexOf("||"+nickname+"||")>-1)var l="";else{if(r.indexOf("www.youtube.com/embed")>-1)var r=r.replace(/href\=\"http\:/gi,'onclick="event.preventDefault();youtube.call(this);" href="http://');if(r.search("{BUZZ}")>-1)var r='<span class="BUZZ">BUZZ</span>';if(void 0==t.user||null==t.user_avatar.length)var i="inherit",c="";else var i=t.user.color;if(null!=t.user_avatar)var c='<img src="'+t.user.avatar+'" />';var l='<p class="block_mess">';l+='<span class="chat_msg"><span class="chat_name">'+c+'<a style="color:'+i+'" href="/u'+t.userId+'" onclick="event.preventDefault();copyname.call(this)">'+t.username+'</a>: </span><span class="chat_content">'+r+"</span></span>",l+="</p>"}contentz+=l}$('.result[key="chatall"]').html(contentz)}else if(getdata.messages.length>lastmess){for(var o=getdata.messages.length,h=lastmess,a=h;o>a;a++){var t=getdata.messages[a],n=t.userId,s=t.username,r=t.msg;if(r.indexOf("||"+nickname+"||")>-1)var l="";else{if(r.indexOf("www.youtube.com/embed")>-1)var r=r.replace(/href\=\"http\:/gi,'onclick="event.preventDefault();youtube.call(this);" href="http://');if(r.search("{BUZZ}")>-1){var r='<span class="BUZZ">BUZZ</span>';a==o-1&&"false"==buzz&&(buzz="true",buzzon())}if(void 0==t.user||null==t.user_avatar)var i="inherit",c="";else var i=t.user.color;if(null!=t.user_avatar)var c='<img src="'+t.user.avatar+'" />';if(r.search(/kicked by|banned by|Messages cleared/gi)>-1)var r=""+r.replace("has been unbanned by","đã được unbanded bởi").replace("has been kicked by","đã bị đá ra khỏi phòng bởi").replace("Messages cleared by","Các tin nhắn đã bị xóa bởi"),l='<p class="block_mess"><span class="chat_content warning">'+r+"</span></p>";else{var l='<p class="block_mess">';l+='<span class="chat_msg"><span class="chat_name">'+c+'<a style="color:'+i+'" href="/u'+n+'" onclick="event.preventDefault();copyname.call(this)">'+s+'</a>: </span><span class="chat_content">'+r+"</span></span>",l+="</p>"}$('.result[key="chatall"] .block_mess:first').before(l)}}lastmess=getdata.messages.length}}function getchat(){$.ajax({url:"chatbox/actions.forum?method=get&tid="+tid+"&archives=1",type:"get",dataType:"json",cache:!1,success:function(e){getdata=e,getdata.messages[0].msg.indexOf("You are disconnected")>-1&&onchat(),getdata.messages[getdata.messages.length-1].msg.indexOf("Messages cleared")>-1&&(lastmess=0),msgchat(),primsg(),user_onl()}})}function sendchat(){data=data_chat,document.Cboxvhg.text.value="",$.ajax({url:"/chatbox/actions.forum",type:"post",data:data,dataType:"json",cache:!1,success:function(){getchat()}})}var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var a,t,n,s,r,l,i,c="",o=0;for(e=Base64._utf8_encode(e);o<e.length;)a=e.charCodeAt(o++),t=e.charCodeAt(o++),n=e.charCodeAt(o++),s=a>>2,r=(3&a)<<4|t>>4,l=(15&t)<<2|n>>6,i=63&n,isNaN(t)?l=i=64:isNaN(n)&&(i=64),c=c+this._keyStr.charAt(s)+this._keyStr.charAt(r)+this._keyStr.charAt(l)+this._keyStr.charAt(i);return c},decode:function(e){var a,t,n,s,r,l,i,c="",o=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");o<e.length;)s=this._keyStr.indexOf(e.charAt(o++)),r=this._keyStr.indexOf(e.charAt(o++)),l=this._keyStr.indexOf(e.charAt(o++)),i=this._keyStr.indexOf(e.charAt(o++)),a=s<<2|r>>4,t=(15&r)<<4|l>>2,n=(3&l)<<6|i,c+=String.fromCharCode(a),64!=l&&(c+=String.fromCharCode(t)),64!=i&&(c+=String.fromCharCode(n));return c=Base64._utf8_decode(c)},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");for(var a="",t=0;t<e.length;t++){var n=e.charCodeAt(t);128>n?a+=String.fromCharCode(n):n>127&&2048>n?(a+=String.fromCharCode(n>>6|192),a+=String.fromCharCode(63&n|128)):(a+=String.fromCharCode(n>>12|224),a+=String.fromCharCode(n>>6&63|128),a+=String.fromCharCode(63&n|128))}return a},_utf8_decode:function(e){for(var a="",t=0,n=c1=c2=0;t<e.length;)n=e.charCodeAt(t),128>n?(a+=String.fromCharCode(n),t++):n>191&&224>n?(c2=e.charCodeAt(t+1),a+=String.fromCharCode((31&n)<<6|63&c2),t+=2):(c2=e.charCodeAt(t+1),c3=e.charCodeAt(t+2),a+=String.fromCharCode((15&n)<<12|(63&c2)<<6|63&c3),t+=3);return a}};$.get("/chatbox").done(function(e){e.indexOf("You have been banned from the ChatBox")>-1?(alert("Bạn đã bị cấm sử dụng chatbox. Hãy liên hệ người quản trị đề biết thêm chi tiết."),$('.result[key="chatall"]').html('<span class="chat_content warning">Bạn đã bị cấm truy cập chatbox</span>'),clearInterval(auto2)):(tid=e.split('new Chatbox("')[1].split('", {')[0],onchat())});var nickname="none",lastmess=0,buzz="false",buzzbtt="no";if(null==localStorage.getItem("nickname")?$.get("/post").done(function(e){nickname=e.split('_userdata["username"] = "')[1].split('";')[0],localStorage.setItem("nickname",""+nickname)}):nickname=localStorage.getItem("nickname"),auto2=setInterval(function(){getchat()},3e3),null!=localStorage.getItem("user_band")){var a=localStorage.getItem("user_band"),d='<a style="color:#000000" data="false" href="javascript:;" onmousedown="bandder.call(this);event.preventDefault();">'+a+"</a>";$(".list_onl .user_band").append(d)}$("#Cboxvhg").submit(function(e){if(e.preventDefault(),""==document.Cboxvhg.text.value)alert("Bạn chưa nhập nội dung chat.");else if(document.Cboxvhg.text.value.length>255)alert("Nội dung bạn nhập quá dài."),document.Cboxvhg.text.value="";else{var a=$(this).attr("key"),t=$('.list_pri a[key="'+a+'"]').text();data_chat="chatall"==a?""+$("input#text").serialize()+"&method=send&archives=1":""+$("input#text").val(Base64.encode($("input#text").val())).serialize().replace("message=","message="+a+"||"+nickname+"||"+t+"||")+"&method=send&archives=1",sendchat(),document.Cboxvhg.text.value=""}}),$("#chen_link").toggle(function(){$(".tab_drop").slideUp(300),$("#linkdechen").slideDown(300)},function(){$(".tab_drop").slideUp(300)}),$("#divsmilies").toggle(function(){$(".tab_drop").slideUp(300),$("#smiley_FB_frame").slideDown(300)},function(){$(".tab_drop").slideUp(300)}),$(".nutchenlink").click(function(){$("#text").val(""+$("#text").val()+"[url]"+$("#link_chen").val()+"[/url]"),$(".tab_drop").slideUp(300),$("input#link_chen").val("")}),$(".nutchenanh").click(function(){var e=$("#link_chen").val();e.search(/png|gif|jpg/gi)>-1?($("#text").val("[img]"+e+"[/img]"),$(".tab_drop").slideUp(300),$("#link_chen").val("")):alert("Xin lỗi đây không phải định dạng ảnh hỗ trợ.")}),$(".nutchenvideo").click(function(){if($("#link_chen").val().length>5){var e=$("#link_chen").val().match(/(?:v=|v\/|embed\/|youtu.be\/)(.{11})/)[1];data_chat="message="+$("#text").val()+"[url=http://www.youtube.com/embed/"+e+"][img]https://img.youtube.com/vi/"+e+"/0.jpg[/img][/url]&method=send&archives=1",sendchat(),$(".tab_drop").slideUp(300),$("#link_chen").val("")}else alert("Xin vui lòng chèn link vào khung.")}),$("#smiley_FB_frame sub").click(function(){var e=encodeURIComponent(""+$("#text").val()+"[sub]"+$(this).text()+"[/sub]");$(".tab_drop").slideUp(300),data_chat="message="+e+"&method=send&archives=1",sendchat()}),$("#chatbox-option-buzz").click(function(){if("no"==buzzbtt){var e=encodeURIComponent("{BUZZ}");data_chat="message="+e+"&method=send&archives=1",sendchat(),buzzbtt="yes";var a=59;$buzz=$("#chatbox-option-buzz"),timeBuzzCount=setInterval(function(){var e=a--;$buzz.attr("value",""+e),0>=e&&(clearInterval(timeBuzzCount),a=59,timeBuzzCount=void 0,$buzz.attr("value"," BUZZ"),buzzbtt="no")},1e3)}});
